import React, { Suspense, lazy } from "react";
import { Provider } from "react-redux";
import {
  Navigate,
  Route,
  BrowserRouter as Router,
  Routes,
} from "react-router-dom";
import { ConfigProvider, theme } from "antd";
import viVN from "antd/locale/vi_VN";
import "./App.css";
import Loading from "./components/Common/Loading";
import Layout from "./components/layout/Layout";
import { store } from "./store/store";
// import PerformanceMonitor from "./utils/PerformanceMonitor";

// Enhanced lazy loading with preloading strategy and performance optimization
const LiveDashboard = lazy(
  () =>
    import(
      /* webpackChunkName: "dashboard", webpackPreload: true */ "./components/Dashboard/LiveDashboard"
    )
);
const AIDashboard = lazy(
  () =>
    import(
      /* webpackChunkName: "ai-dashboard", webpackPrefetch: true */ "./components/ai/AIDashboard"
    )
);
const GoogleSheetsIntegration = lazy(
  () =>
    import(
      /* webpackChunkName: "google-sheets", webpackPrefetch: true */ "./components/google/GoogleSheetsIntegration"
    )
);
const GoogleDriveIntegration = lazy(
  () =>
    import(
      /* webpackChunkName: "google-drive", webpackPrefetch: true */ "./components/google/GoogleDriveIntegration"
    )
);
const GoogleAppsScriptIntegration = lazy(
  () =>
    import(
      /* webpackChunkName: "google-apps-script", webpackPrefetch: true */ "./components/google/GoogleAppsScriptIntegration"
    )
);
const TelegramIntegration = lazy(
  () =>
    import(
      /* webpackChunkName: "telegram", webpackPrefetch: true */ "./components/telegram/TelegramIntegration"
    )
);
const AutomationDashboard = lazy(
  () =>
    import(
      /* webpackChunkName: "automation", webpackPrefetch: true */ "./components/automation/AutomationDashboard"
    )
);
const AutomationPanel = lazy(
  () =>
    import(
      /* webpackChunkName: "automation-panel", webpackPrefetch: true */ "./components/automation/AutomationPanelWrapper"
    )
);
const ConfigPage = lazy(
  () =>
    import(
      /* webpackChunkName: "config", webpackPrefetch: true */ "./components/automation/ConfigPageWrapper"
    )
);

// Intelligent preloading based on user behavior
const preloadComponent = (componentLoader, priority = "low") => {
  if ("requestIdleCallback" in window) {
    window.requestIdleCallback(
      () => {
        componentLoader();
      },
      { timeout: priority === "high" ? 2000 : 5000 }
    );
  } else {
    setTimeout(
      () => {
        componentLoader();
      },
      priority === "high" ? 100 : 2000
    );
  }
};

// Progressive preloading strategy
if (typeof window !== "undefined") {
  // Immediate preload for critical routes
  preloadComponent(
    () => import("./components/Dashboard/LiveDashboard"),
    "high"
  );

  // Preload frequently used components after initial load
  setTimeout(() => {
    preloadComponent(() => import("./components/ai/AIDashboard"), "medium");
    preloadComponent(
      () => import("./components/google/GoogleSheetsIntegration"),
      "medium"
    );
  }, 3000);

  // Preload remaining components when browser is idle
  setTimeout(() => {
    preloadComponent(
      () => import("./components/google/GoogleDriveIntegration")
    );
    preloadComponent(
      () => import("./components/automation/AutomationDashboard")
    );
  }, 5000);
}

// Home component
const Home = () => (
  <div className="home-container">
    <div className="hero-section">
      <h1>üöÄ MIA Logistics Integration v3.0</h1>
      <p>H·ªá th·ªëng qu·∫£n l√Ω logistics th√¥ng minh v·ªõi AI v√† Google Integration</p>
    </div>

    <div className="features-grid">
      <div className="feature-card primary">
        <h3>üìä Live Dashboard</h3>
        <p>
          Theo d√µi th·ªùi gian th·ª±c, gi√°m s√°t hi·ªáu su·∫•t v√† ph√¢n t√≠ch h·ªá th·ªëng v·ªõi
          WebSocket integration.
        </p>
        <div className="feature-stats">
          <div className="stat">
            <span className="stat-value">99.9%</span>
            <span className="stat-label">Uptime</span>
          </div>
          <div className="stat">
            <span className="stat-value">2.3s</span>
            <span className="stat-label">Response Time</span>
          </div>
        </div>
      </div>

      <div className="feature-card secondary">
        <h3>üß† AI Analytics</h3>
        <p>
          Ph√¢n t√≠ch th√¥ng minh, d·ª± ƒëo√°n xu h∆∞·ªõng v√† khuy·∫øn ngh·ªã t·ªëi ∆∞u h√≥a cho
          h·ªá th·ªëng logistics.
        </p>
        <div className="feature-stats">
          <div className="stat">
            <span className="stat-value">92%</span>
            <span className="stat-label">Accuracy</span>
          </div>
          <div className="stat">
            <span className="stat-value">15%</span>
            <span className="stat-label">Cost Reduction</span>
          </div>
        </div>
      </div>

      <div className="feature-card tertiary">
        <h3>üìã Google Sheets</h3>
        <p>
          T√≠ch h·ª£p Google Sheets ƒë·ªÉ qu·∫£n l√Ω d·ªØ li·ªáu, b√°o c√°o v√† t·ª± ƒë·ªông h√≥a quy
          tr√¨nh l√†m vi·ªác.
        </p>
        <div className="feature-stats">
          <div className="stat">
            <span className="stat-value">1,250</span>
            <span className="stat-label">Records</span>
          </div>
          <div className="stat">
            <span className="stat-value">24/7</span>
            <span className="stat-label">Sync</span>
          </div>
        </div>
      </div>
    </div>

    <div className="features-grid">
      <div className="feature-card">
        <h3>üìà Tr·∫°ng th√°i h·ªá th·ªëng</h3>
        <div className="status-list">
          <div className="status-item">
            <span className="status-icon">‚úÖ</span>
            <div className="status-content">
              <span className="status-title">Frontend</span>
              <span className="status-desc">T·ªëi ∆∞u h√≥a & Tri·ªÉn khai</span>
            </div>
          </div>
          <div className="status-item">
            <span className="status-icon">‚úÖ</span>
            <div className="status-content">
              <span className="status-title">Backend</span>
              <span className="status-desc">WebSocket Ready</span>
            </div>
          </div>
          <div className="status-item">
            <span className="status-icon">‚úÖ</span>
            <div className="status-content">
              <span className="status-title">Automation</span>
              <span className="status-desc">Ho·∫°t ƒë·ªông</span>
            </div>
          </div>
        </div>
        <div className="system-health">
          <span className="health-label">T√¨nh tr·∫°ng h·ªá th·ªëng:</span>
          <span className="health-status healthy">Kh·ªèe m·∫°nh</span>
        </div>
      </div>

      <div className="feature-card">
        <h3>üéØ T√≠nh nƒÉng m·ªõi v3.0</h3>
        <div className="feature-tags">
          {[
            "üì° T√≠ch h·ª£p WebSocket th·ªùi gian th·ª±c",
            "üìä Dashboard hi·ªáu su·∫•t tr·ª±c ti·∫øp",
            "‚ö° C·∫£i thi·ªán hi·ªáu su·∫•t 50%",
            "üé® Thi·∫øt k·∫ø UI/UX hi·ªán ƒë·∫°i",
            "üì± H·ªó tr·ª£ di ƒë·ªông responsive",
            "üîí T√≠nh nƒÉng b·∫£o m·∫≠t n√¢ng cao",
          ].map((feature, index) => (
            <span key={index} className="feature-tag">
              {feature}
            </span>
          ))}
        </div>
      </div>
    </div>
  </div>
);

// Main App component with Router v√† Performance Monitoring
function App() {
  // Initialize Performance Monitor (t·∫°m th·ªùi disabled ƒë·ªÉ test build)
  React.useEffect(() => {
    // const monitor = new PerformanceMonitor();
    // monitor.startMonitoring();

    // Cleanup khi component unmount
    return () => {
      // monitor.stopMonitoring();
    };
  }, []);

  return (
    <Provider store={store}>
      <ConfigProvider
        locale={viVN}
        theme={{
          algorithm: theme.defaultAlgorithm,
          token: {
            colorPrimary: "#3b82f6",
            borderRadius: 8,
          },
        }}
      >
        <Router>
          <div className="App">
            <Layout>
              <Suspense fallback={<Loading />}>
                <Routes>
                  <Route path="/" element={<Home />} />
                  <Route path="/dashboard" element={<LiveDashboard />} />
                  <Route path="/ai-analytics" element={<AIDashboard />} />
                  <Route
                    path="/google-sheets"
                    element={<GoogleSheetsIntegration />}
                  />
                  <Route
                    path="/google-drive"
                    element={<GoogleDriveIntegration />}
                  />
                  <Route
                    path="/google-apps-script"
                    element={<GoogleAppsScriptIntegration />}
                  />
                  <Route path="/telegram" element={<TelegramIntegration />} />
                  <Route path="/automation" element={<AutomationDashboard />} />
                  <Route
                    path="/automation/control"
                    element={<AutomationPanel />}
                  />
                  <Route path="/automation/config" element={<ConfigPage />} />
                  <Route path="*" element={<Navigate to="/" replace />} />
                </Routes>
              </Suspense>
            </Layout>
          </div>
        </Router>
      </ConfigProvider>
    </Provider>
  );
}

export default App;
